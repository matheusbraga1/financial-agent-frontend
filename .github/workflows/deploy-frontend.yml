name: CI/CD - Deploy Frontend to Production

on:
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'vite.config.js'
      - 'Dockerfile'
      - 'nginx/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-frontend.yml'

  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  IMAGE_NAME: financial-agent-frontend
  CONTAINER_NAME: financial-agent-frontend

jobs:
  # ============================================================================
  # Stage 1: Code Quality & Linting
  # ============================================================================
  lint:
    name: Code Quality & Linting
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        run: |
          # Verifica se Node.js 20 est√° instalado
          if ! command -v node &> /dev/null || [[ "$(node -v)" != v20* ]]; then
            echo "‚ö†Ô∏è  Node.js 20 n√£o encontrado. Por favor, instale Node.js 20."
            exit 1
          fi
          echo "‚úÖ Node.js $(node -v) encontrado"
          echo "‚úÖ npm $(npm -v) encontrado"

      - name: Cache node_modules
        id: cache-node-modules
        run: |
          CACHE_DIR="$HOME/.npm-cache/financial-agent-frontend"
          mkdir -p "$CACHE_DIR"

          if [ -d "node_modules" ]; then
            echo "‚úÖ node_modules j√° existe"
            echo "cached=true" >> $GITHUB_OUTPUT
          else
            echo "üì¶ node_modules n√£o existe, ser√° instalado"
            echo "cached=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cached != 'true'
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci --prefer-offline --no-audit

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Build test
        env:
          VITE_API_URL: http://192.168.1.150/api/v1
          VITE_ENABLE_LOGS: false
          VITE_APP_VERSION: ${{ github.sha }}
        run: |
          echo "üî® Testing build..."
          npm run build:prod

      - name: Check build output
        run: |
          echo "‚úÖ Build completed successfully"
          ls -lah dist/
          du -sh dist/

  # ============================================================================
  # Stage 2: Build Docker Image
  # ============================================================================
  build:
    name: Build Docker Image
    runs-on: self-hosted
    needs: lint

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="prod-${SHORT_SHA}-${TIMESTAMP}"
          echo "tags=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Building image with tag: ${IMAGE_TAG}"

      - name: Build Docker image
        env:
          COMMIT_SHA: ${{ github.sha }}
          IMAGE_TAG: ${{ steps.meta.outputs.tags }}
        run: |
          echo "üî® Building Docker image..."
          docker build \
            --build-arg VITE_API_URL=http://192.168.1.150/api/v1 \
            --build-arg VITE_ENABLE_LOGS=false \
            --build-arg VITE_APP_VERSION=$COMMIT_SHA \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f Dockerfile .

      - name: Verify image
        run: |
          echo "üîç Verifying built image..."
          docker images | grep ${IMAGE_NAME}
          echo "‚úÖ Image built successfully"

  # ============================================================================
  # Stage 3: Deploy to Production
  # ============================================================================
  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: build
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Backup current deployment
        run: |
          echo "üì¶ Creating backup of current deployment..."

          # Backup da imagem atual se existir
          if docker ps -a | grep -q ${CONTAINER_NAME}; then
            CURRENT_IMAGE=$(docker inspect ${CONTAINER_NAME} --format='{{.Image}}')
            docker tag $CURRENT_IMAGE ${IMAGE_NAME}:backup-$(date +%Y%m%d-%H%M%S) || true
            echo "‚úÖ Backup created"
          else
            echo "‚ÑπÔ∏è  No previous deployment found"
          fi

      - name: Stop current container
        run: |
          echo "‚èπÔ∏è  Stopping current container..."
          docker stop ${CONTAINER_NAME} || true
          docker rm ${CONTAINER_NAME} || true
          echo "‚úÖ Container stopped"

      - name: Start new container
        env:
          IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
        run: |
          echo "üöÄ Starting new container..."
          docker run -d \
            --name ${CONTAINER_NAME} \
            --network financial-agent-network \
            -p 3000:3000 \
            --restart unless-stopped \
            --log-driver json-file \
            --log-opt max-size=10m \
            --log-opt max-file=3 \
            ${IMAGE_NAME}:${IMAGE_TAG}

          echo "‚úÖ Container started"

      - name: Wait for container to be ready
        run: |
          echo "‚è≥ Waiting for container to be ready..."
          sleep 10

      - name: Health check
        run: |
          echo "üè• Running health checks..."

          MAX_ATTEMPTS=12
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if docker exec ${CONTAINER_NAME} curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              break
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting..."
            sleep 5

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "‚ùå Health check failed!"
              echo "üìã Container logs:"
              docker logs --tail 50 ${CONTAINER_NAME}
              exit 1
            fi
          done

      - name: Cleanup old images
        run: |
          echo "üßπ Cleaning up old images..."
          # Mant√©m apenas as √∫ltimas 3 imagens tagged
          docker images ${IMAGE_NAME} --format "{{.ID}} {{.Tag}}" | \
            grep -v "latest\|backup" | \
            tail -n +4 | \
            awk '{print $1}' | \
            xargs -r docker rmi -f || true

          # Remove imagens dangling
          docker image prune -f
          echo "‚úÖ Cleanup completed"

  # ============================================================================
  # Stage 4: Post-Deploy Validation
  # ============================================================================
  validate:
    name: Post-Deploy Validation
    runs-on: self-hosted
    needs: deploy

    steps:
      - name: Container status check
        run: |
          echo "üîç Checking container status..."

          if docker ps | grep -q ${CONTAINER_NAME}; then
            echo "‚úÖ Container is running"
          else
            echo "‚ùå Container is not running"
            exit 1
          fi

      - name: Application health check
        run: |
          echo "üè• Testing application health..."

          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health)
          if [ "$response" = "200" ]; then
            echo "‚úÖ Health endpoint returned 200"
          else
            echo "‚ùå Health check failed with status $response"
            exit 1
          fi

      - name: Network connectivity check
        run: |
          echo "üåê Testing network connectivity..."

          # Verifica se consegue acessar a aplica√ß√£o via rede
          if curl -f http://192.168.1.150 > /dev/null 2>&1; then
            echo "‚úÖ Application accessible via network"
          else
            echo "‚ö†Ô∏è  Application may not be accessible externally"
          fi

      - name: Deployment summary
        run: |
          echo "=================================="
          echo "‚úÖ Deployment completed successfully!"
          echo "=================================="
          echo "üì¶ Container: ${CONTAINER_NAME}"
          echo "üåê URL: http://192.168.1.150"
          echo "üìù Commit: ${{ github.sha }}"
          echo ""
          echo "üìã Container details:"
          docker ps | grep ${CONTAINER_NAME}

  # ============================================================================
  # Rollback on Failure
  # ============================================================================
  rollback:
    name: Rollback on Failure
    runs-on: self-hosted
    needs: [deploy, validate]
    if: failure()

    steps:
      - name: Stop failed deployment
        run: |
          echo "‚ö†Ô∏è  Deployment failed - initiating rollback..."
          docker stop ${CONTAINER_NAME} || true
          docker rm ${CONTAINER_NAME} || true

      - name: Restore previous deployment
        run: |
          # Encontra a imagem de backup mais recente
          BACKUP_IMAGE=$(docker images ${IMAGE_NAME} --format "{{.Repository}}:{{.Tag}}" | grep backup | head -n 1)

          if [ -z "$BACKUP_IMAGE" ]; then
            echo "‚ùå No backup image found for rollback"

            # Tenta usar a pen√∫ltima imagem tagged
            PREVIOUS_IMAGE=$(docker images ${IMAGE_NAME} --format "{{.ID}}" | sed -n '2p')

            if [ -z "$PREVIOUS_IMAGE" ]; then
              echo "‚ùå No previous image found"
              exit 1
            fi

            echo "üì¶ Rolling back to previous image: $PREVIOUS_IMAGE"
            BACKUP_IMAGE=$PREVIOUS_IMAGE
          else
            echo "üì¶ Rolling back to backup: $BACKUP_IMAGE"
          fi

          docker run -d \
            --name ${CONTAINER_NAME} \
            --network financial-agent-network \
            -p 3000:3000 \
            --restart unless-stopped \
            $BACKUP_IMAGE

          echo "‚úÖ Rollback completed"

      - name: Verify rollback
        run: |
          echo "üîç Verifying rollback..."
          sleep 10

          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "‚úÖ Rollback successful - application is healthy"
          else
            echo "‚ùå Rollback verification failed"
            docker logs --tail 50 ${CONTAINER_NAME}
            exit 1
          fi

      - name: Rollback notification
        run: |
          echo "=================================="
          echo "‚ö†Ô∏è  Deployment was rolled back"
          echo "=================================="
          echo "Check logs for failure details:"
          docker logs --tail 100 ${CONTAINER_NAME}
